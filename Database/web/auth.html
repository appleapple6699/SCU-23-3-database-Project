<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登录 / 注册</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  </head>
  <body>
    <div class="nav">
      <div class="nav-inner">
        <div class="brand">Database</div>
        <div class="nav-links">
          <a href="/">演示</a>
          <a href="/admin.html">管理员</a>
          <a href="/leader.html">组长</a>
          <a href="/member.html">组员</a>
          <a href="/auth.html">登录/注册</a>
        </div>
        <div class="nav-right">
          <span id="status">未登录</span>
          <button class="btn btn-outline" onclick="logout()">退出登录</button>
        </div>
      </div>
    </div>
    <div id="app" class="container">
      <h1>登录 / 注册</h1>
      <el-card class="card">
        <h2>登录</h2>
        <el-form :model="login" :rules="loginRules" ref="loginRef" label-width="90px">
          <el-form-item label="账号" prop="phone">
            <el-input v-model="login.phone" placeholder="手机号或UserID" />
          </el-form-item>
          <el-form-item label="密码" prop="password">
            <el-input v-model="login.password" placeholder="密码" type="password" />
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="submitLogin">登录</el-button>
          </el-form-item>
        </el-form>
        <pre v-text="pretty(loginResult)"></pre>
      </el-card>

      <el-card class="card">
        <h2>注册</h2>
        <el-form :model="reg" :rules="regRules" ref="regRef" label-width="90px">
          <el-form-item label="昵称" prop="nickname">
            <el-input v-model="reg.nickname" placeholder="昵称" />
          </el-form-item>
          <el-form-item label="手机号" prop="phone">
            <el-input v-model="reg.phone" placeholder="手机号" />
          </el-form-item>
          <el-form-item label="密码" prop="password">
            <el-input v-model="reg.password" placeholder="密码" type="password" />
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="submitRegister">注册</el-button>
          </el-form-item>
        </el-form>
        <pre v-text="pretty(regResult)"></pre>
      </el-card>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <script src="/app.js"></script>
    <script>
      const { createApp } = Vue;
      const app = createApp({
        data(){
          return {
            login: { phone:'', password:'' }, loginResult: null,
            reg: { nickname:'', phone:'', password:'' }, regResult: null,
            loginRules: {
              phone: [{ required: true, message: '请输入账号', trigger: 'blur' }],
              password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
            },
            regRules: {
              nickname: [{ required: true, message: '请输入昵称', trigger: 'blur' }],
              phone: [{ required: true, message: '请输入手机号', trigger: 'blur' }],
              password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
            },
          };
        },
        methods: {
          pretty(v){ return v ? JSON.stringify(v, null, 2) : ''; },
          submitLogin(){
            this.$refs.loginRef.validate(async (valid) => {
              if (!valid) return;
              const data = await api.request('/api/users/login','POST',{...this.login});
              this.loginResult = data;
              if (data && data.error_code === 0 && data.data) {
                localStorage.setItem('token', data.data.token);
                localStorage.setItem('user_id', data.data.user_id);
                showStatus();
              }
            });
          },
          submitRegister(){
            this.$refs.regRef.validate(async (valid) => {
              if (!valid) return;
              const data = await api.request('/api/users/register','POST',{...this.reg});
              this.regResult = data;
            });
          },
        }
      });
      app.use(ElementPlus);
      app.mount('#app');
    </script>
  </body>
  </html>